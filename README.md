# Retrieve模型程式碼說明

主程式為  main.py  包含了兩種模型 **M3** 與 **BM25**，此程式利用了兩種不同的模型針對不同類型的問題，來優化整體 retrieve 的表現。  

- faq 類型 以 **M3** 處理
- finance 類型 以 **BM25** 處理
- insurance 類型 以 **M3** 處理

## 安裝指令

```bash
pip install -r requirements.txt
```


# 程式碼說明

此程式需要從外部引入三個 Python 程式 (皆可在repository下載)：

1. **`tools.py`**：包含處理正則表示的函數。
2. **`bm25.py`**：BM25 模型的主程式。
3. **`m3.py`**：M3 模型的主程式。

### `tools.py` 概述

- **正則表示統一函數**：`align_expression(input_text, csv_path)`
  - 功能：使用正則表示統一不同的表達方式。
  - 依賴檔案：此函數需要使用 **`TW_comp_list.csv`**，讀取台灣所有公司名稱的相關資訊。
  - 使用情境：此函數在 **`bm25.py`** 與 **`m3.py`** 中被調用，用於文本的正則表達統一。

### `bm25.py` 概述

- **四個前處理方法**：
  1. **正則表示統一**：
     - 功能：統一不同的文本表達，例如公司全名、縮寫、英文名稱，民國/西元年、台/臺、中文數字/阿拉伯數字等。
  2. **客製化切詞**：
     - 功能：將財經、保險相關的專業用語加入 **jieba** 的客製化辭典中，以提升切詞的精確度。
  3. **動態調整切詞**：
     - 功能：根據問句的切詞結果，動態更新文本的切詞方式。
     - 實作方法：將問句切詞後的所有切詞結果以最高權重加入 **jieba** 的客製化辭典，然後使用加強後的 **jieba** 進行文本切詞。
  4. **過濾非關鍵字**：
     - 功能：移除語句中無關鍵詞的字，例如: '在'、'的'、'非'、'及'、'中'、'要'、'仍'、'後'、'並'、'或'、'於'、'是'、'嗎'，使模型更加專注於關鍵字。

- **模型**：
  - 相似度計算模型與 baseline 一致，無進行修改。

### `m3.py` 概述

- **前處理方法**（部分與 BM25 重疊）：
  1. **正則表示統一**。
  2. **客製化切詞**。

- **模型**：
  1. **基於句子為單位進行相似度計算**：
     - 將文檔切分為句子，並從中選取與問題最相關的句子作為代表，以計算該文檔與問句的相似度。
  2. **選擇性過濾**：
     - 過濾掉文檔中不包含**與問句相關關鍵字**的句子，目的是減小模型的大小並提升處理效率。


## 輸入說明

- 程式會根據程式碼內的 `qs_path = './questions_preliminary.json'` 變數所指定的路徑，讀取問題。
- 程式會根據程式碼中的以下變數：
  - `path_to_insurance = "./processed_reference/insurance.json"`
  - `path_to_faq = "./processed_reference/faq.json"`
  - `path_to_finance = "./processed_reference/finance.json"`
  
  讀取預處理過後的 JSON 檔案，並將讀取出的內容用於後續的模型處理。


**注意**  
本模型所使用的輸入 JSON 檔案是經過人工處理後的結果，因此無法完全透過上述的預處理程式碼重現。人工處理的部分包括：

1. **人工檢查並讀取品質不佳的檔案**（約 12 個檔案）：
   - 使用 Google 網站上的 OCR 工具或 Line 支援的 OCR 工具，將這些檔案重新轉換為文字檔。

2. **關鍵字人工檢視與詞典更新**：
   - 人工檢視文件中的關鍵字，並將這些關鍵字新增到切詞的詞典中，以提升切詞的準確性。


## 輸出說明

- 程式會將結果檔 `pred_retrieve.json` 輸出至當前資料夾。

## 必要的附加檔案(可在repository下載)

1. **`costum_comp.txt`** 所有公司的縮寫名稱，在 `m3.py` 中會用到。
2. **`costum_dict.txt`** 客製化的切詞辭典，在 `bm25.py` 與 `m3.py` 中會用到。
3. **`TW_comp_list.csv`** 台灣所有公司名稱的相關資訊
4. **`questions_preliminary.json`** 初賽時的比賽題目
